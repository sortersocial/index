<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>#{{ hashtag }} - Sorter</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/lists.css">
    <link rel="stylesheet" href="/static/css/votes.css">
    <link rel="stylesheet" href="/static/css/markdown.css">
</head>
<body>
    {% include "_github_corner.html" %}
    <div class="back-link">
        <a href="/">&larr; Back to index</a>
    </div>

    <h1>#{{ hashtag }}</h1>

    {% if available_attributes %}
    <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <strong>View by attribute:</strong>
        {% for attr, count in available_attributes %}
        {% if attr == current_attribute %}
        <span style="padding: 4px 12px; background: #4a90e2; color: white; border-radius: 4px; margin: 0 4px;">:{{ attr }}</span>
        {% else %}
        <a href="/hashtag/{{ hashtag }}?attribute={{ attr }}" style="padding: 4px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; margin: 0 4px; text-decoration: none; color: #333;">:{{ attr }}</a>
        {% endif %}
        <span style="color: #999; font-size: 0.9em;">({{ count }})</span>
        {% endfor %}
    </div>
    {% endif %}

    {% if current_attribute %}
    <p class="stats">
        Ranking by <strong>:{{ current_attribute }}</strong>
        {% if vote_count is defined %}
        · {{ vote_count }} votes
        {% endif %}
    </p>
    {% endif %}

    <div class="action-buttons">
        <a href="mailto:about@mail.sorter.social?subject={{ ('Add to #' + hashtag)|urlencode }}&body={{ ('#' + hashtag + '\n\n/item-name { description }')|urlencode }}" class="button">
            Add Item
        </a>
    </div>

    {% if components %}
        {% if components|length > 1 %}
        <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
            <strong>⚠️ Disconnected Groups:</strong> Found {{ components|length }} separate groups. Items in different groups haven't been compared yet.
            <a href="mailto:about@mail.sorter.social?subject={{ ('Bridge vote for #' + hashtag)|urlencode }}&body={{ ('#' + hashtag + '\n\n' + ':' + (current_attribute or 'overall') + '\n/item1 > /item2')|urlencode }}">Vote to connect them!</a>
        </div>
        {% endif %}

        {% for component in components %}
            {% if components|length > 1 %}
            <h3 style="margin-top: 30px; color: #666;">Group {{ component.id + 1 }}</h3>
            {% endif %}

            <ol class="item-list" {% if components|length > 1 %}start="1"{% endif %}>
                {% for title, score, rank, record in component.items %}
                <li>
                    <div>
                        <span class="item-rank">#{{ rank }}</span>
                        <span class="item-title">{{ title }}</span>
                        <span style="color: #999; font-size: 0.9em; margin-left: 8px;">
                            (score: {{ "%.4f"|format(score) }})
                        </span>
                    </div>
                    {% if record.body %}
                    <div class="item-body">{{ record.body|markdown }}</div>
                    {% endif %}
                    <div class="item-meta">
                        {% if record.created_by %}
                        Created by <a href="/user/{{ record.created_by }}">{{ record.created_by }}</a>
                        {% endif %}
                        {% if record.timestamp %}
                        · {{ record.timestamp|relative_time }}
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ol>
        {% endfor %}
    {% elif items %}
        <ol class="item-list">
            {% for title, record in items %}
            <li>
                <div>
                    <span class="item-title">{{ title }}</span>
                </div>
                {% if record.body %}
                <div class="item-body">{{ record.body|markdown }}</div>
                {% endif %}
            </li>
            {% endfor %}
        </ol>
    {% else %}
    <p class="no-items">No items yet under this hashtag.</p>
    {% endif %}

    {% if votes %}
    <h2>Vote History</h2>
    <ul class="vote-list">
        {% for vote in votes %}
        <li class="vote-item">
            {% set canonical_item1 = [vote.item1, vote.item2]|sort|first %}
            {% set canonical_item2 = [vote.item1, vote.item2]|sort|last %}
            <div class="vote-comparison">
                <a href="/compare/{{ canonical_item1 }}/vs/{{ canonical_item2 }}">
                    <span class="vote-item-name">{{ vote.item1 }}</span>
                    <span class="vote-arrow">→</span>
                    <span class="vote-item-name">{{ vote.item2 }}</span>
                </a>
            </div>
            <div class="vote-slider-container">
                {% set total = vote.ratio_left + vote.ratio_right %}
                {% set percentage = (vote.ratio_left / total * 100)|int %}
                <input 
                    type="range" 
                    min="0" 
                    max="100" 
                    value="{{ percentage }}" 
                    class="vote-slider"
                    disabled
                >
                <div class="vote-ratio">
                    {{ vote.ratio_left }}:{{ vote.ratio_right }}
                    ({{ vote.item1 }} {{ percentage }}% preferred)
                </div>
            </div>
            {% if vote.explanation %}
            <div class="vote-explanation">{{ vote.explanation|markdown }}</div>
            {% endif %}
            <div class="vote-meta">
                {% if vote.user_email %}
                by {{ vote.user_email }}
                {% endif %}
                {% if vote.timestamp %}
                · {{ vote.timestamp|relative_time }}
                {% endif %}
                {% if vote.attribute %}
                · attribute: {{ vote.attribute }}
                {% endif %}
                {% if vote.source_filename %}
                · <a href="/emails/{{ vote.source_filename }}" target="_blank">view email</a>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</body>
</html>
